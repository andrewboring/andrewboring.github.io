<!DOCTYPE html>
<html lang="en">
<head>
        <title>Andrew Boring : Let's Encrypt with Multisite Wordpress</title>
        <meta charset="utf-8" /> <link rel="stylesheet" href="../theme/css/main.css" type="text/css" />
        <link href="../" type="application/atom+xml" rel="alternate" title="Andrew Boring ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie.css"/>
                <script src="../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie6.css"/><![endif]-->

		<link rel="stylesheet" href="../theme/css/youtube.css" type="text/css" />

</head>

<body>
  	<div id="wrap" style="width:1024px">
	      <div id="container" style="width:700px">

            <div class="entry">
<header>
<h1><a href=".." id="site-title">  </a>         <a href="../drafts/wp-letsencrypt.html" id="page-title">Let's Encrypt with Multisite Wordpress</a></h1>
</header>

<div id="back">
  <a href="..">Return to Launch Page</a> 
</div>

<article>
    <p>At one time, I ran a Wordpress Multisite configuration with multiple domains served out of a single webroot, and wanted to enable https for each managed site.</p>
<p>With Wordpress Multisite on a single webroot (eg, /var/www/html), we can define multiple domain namespaces and point them at any internal directory structure we want. That is, we can easily configure Apache such that a request for the domain/path goes anywhere on the server:</p>
<p>example.com -&gt; /var/www/html<br>
example.com/path -&gt; /var/www/html/path<br>
example.com/path2 -&gt; /home/data/path2<br>
example2.com -&gt; /var/www/html/example2<br>
subdomain.example2.com -&gt; /var/www/subdomain-example2  </p>
<p>Why not point all requests for /.well-known/acme-challenge validation, irrespective of domain, a single directory that certbot can write to?  </p>
<p><strong>Assumptions:</strong>
Apache web server
ModAlias
ModSSL</p>
<p>I used CentOS 7 and Apache on a single-tenant system, so your particular config will need to be adjusted if you're trying this on cPanel or similar.</p>
<p>In your webroot, create the validation directory. Certbot will write all challenge files here.</p>
<div class="highlight"><pre><span></span># mkdir -p /var/www/html/.well-known/acme-challenge
</pre></div>


<p><strong>Default</strong> Apache Virtualhost (Wordpress) Config
Apache will read all .conf files in alphabetical order, and the very first Virtualhost configuration in that order will be the "default" vhost served if none other matches. This is important to know if Wordpress coexists with other web applications. If you're only running Wordpress Multisite and nothing else, you can put this in your httpd.conf file or in a separate virtualhost config. If you have many applications, I'd recommend naming this 00-default.conf or similar to ensure that it is the first one read by Apache (the number "0" comes before the letter "a" in computing).</p>
<div class="highlight"><pre><span></span>[root@s html]# cat /etc/httpd/conf.d/00-default.conf

AliasMatch ^/.well-known/acme-challenge/(.*)$ /var/www/html/.well-known/acme-challenge/$1

SSLStrictSNIVHostCheck off

<span class="nt">&lt;VirtualHost</span> <span class="err">198.51.100.57:80</span><span class="nt">&gt;</span>
 ServerName example.com
 #ServerAlias *.example.com
 DocumentRoot /var/www/html/wp
 ServerAdmin goaway@example.com
 ErrorLog logs/example.com-error_log
 LogLevel alert rewrite:trace3
 TransferLog logs/example.com-access_log
<span class="nt">&lt;/VirtualHost&gt;</span>


<span class="nt">&lt;VirtualHost</span> <span class="err">198.51.100.57:443</span><span class="nt">&gt;</span>
 DocumentRoot &quot;/var/www/html/wp&quot;
 ServerName example.com:443
 ErrorLog logs/example.com-ssl_error_log
 TransferLog logs/example.com-ssl_access_log
 LogLevel warn

 SSLEngine on
 SSLProtocol all -SSLv2 -SSLv3
 SSLCipherSuite HIGH:3DES:!aNULL:!MD5:!SEED:!IDEA
 SSLCertificateFile /etc/letsencrypt/live/example.com/fullchain.pem
 SSLCertificateKeyFile /etc/letsencrypt/live/example.com/privkey.pem
<span class="nt">&lt;/VirtualHost&gt;</span>                                  
</pre></div>


<p>The AliasMatch directive will map the ACME validation path to each domain that Apache serves.</p>
<p>So as long as Apache or Wordpress is configured to respond against that domain name (eg, with the domain mapping entry already applied to a given Wordpress site), it will match all URL paths of the form ".well-known/acme-challenge" to whatever domain is being requested.</p>
<p>When it's time to run certbot, use something like this:</p>
<div class="highlight"><pre><span></span>certbot certonly --webroot -w /var/www/html --cert-name example.com \  
  -d example.com -d www.example.com \  
  -d example2.com -d www.example2.com \  
  -d example3.com -d www.example3.com \   
</pre></div>


<p>I spread this across four lines for readability, but this is entered as one line.</p>
<ul>
<li>The certonly directive tells certbot not to mess with our web server config.</li>
<li>--webroot means use the webroot challenge, not DN</li>
<li>-w tells us the main webroot where it can find the .well-known directory to write the challenge files.</li>
<li>--cert-name is the primary cert for the wordpress multisite. Here, it's example.com.</li>
<li>-d [domain] adds the domain(s) to the certificate.</li>
</ul>
</article>


            </div>
        </div>



        <div id="sidebar">
            <h1><a href=".. " title="title">Andrew Boring</a></h1>
            <span class="description">There are many Andrews in this world, but only I am Boring. </span>
            <!-- <span class="feed"><a href="">RSS</a> | <a href="">Atom</a></span> -->

			      <p>&nbsp;</p>
            <nav>
				          <h2>Pages</h2>
                  <ul>
                    <li><a href="../pages/about.html">About</a> </li>
                    <li><a href="../pages/contact.html">Contact</a> </li>
                    <li><a href="../pages/resume.html">Resume</a></li>
                </ul>
            </nav>

                <div class="widget social">
                        <h2>Social</h2>
                        <ul>
                            <li><a href="https://linkedin.com/in/andrewboring">LinkedIn</a></li>
                            <li><a href="https://twitter.com/andrewboring">Twitter</a></li>
                            <li><a href="https://soundcloud.com/andrewboring">SoundCloud</a></li>
                            <li><a href="https://github.com/andrewboring">Github</a></li>
                        </ul>
               	</div>


            <div class="widget blogroll">
                <h2>Data</h2>
                <ul>
                    <li><a href="../sitemap.xml">sitemap</a></li>
                    <li><a href="../feeds/all/atom.xml" rel="alternate">atom feed</a></li>
                </ul>
            </div>

		    </div>

		    <div id="footer">
        	<div id="credits">
           		 <span></span>
       		 </div>
      	 </div>


    </div>

<script src="https://embed.small.chat/T69NDBZ7DG6AMU0S14.js" async></script>
</body>
</html>